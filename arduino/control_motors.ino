#include <Servo.h>
#include <Stepper.h>
#include <stdbool.h>

Servo servo_cyl;
Servo servo_pen;

const int stepsPerRevolution = 200;
Stepper stepper_belt(stepsPerRevolution, 3, 5, 6, 9);;


int pos_pen_on = 90;
int pos_pen_off = 150;
int pos_cyl_ini = 0;
int pos_cyl_actual = pos_cyl_ini;

void setup() {
  // put your setup code here, to run once:
  short int id_pix[391][2] =
{{2,4},  {2,5},  {2,6},  {2,8},  {2,9},  {2,16}, {2,17}, {2,20},  {2,21}, {2,26}, {2,30},  {2,41}, {2,43}, {2,44}, {2,45}, {3,3},  {3,4},  {3,8},  {3,17}, {3,20},  {3,22}, {3,26}, {3,27}, {3,29}, {3,41}, {3,45}, {4,2},  {4,3},  {4,9},  {4,10},  {4,11}, {4,12}, {4,18}, {4,23}, {4,27}, {4,41}, {4,45}, {4,46}, {5,4},  {5,23}, {5,41}, {5,46}, {5,49}, {6,4},  {6,5},  {6,6},  {6,7},  {6,40},  {6,41}, {6,48},
{6,49}, {7,2},  {7,3},  {7,7},  {7,8},  {7,34}, {7,35}, {7,39}, {7,40},  {7,44}, {7,45}, {7,46}, {7,47}, {8,13}, {8,14}, {8,32}, {8,33}, {8,38}, {8,39}, {8,46}, {9,3},  {9,4},  {9,11}, {9,12}, {9,13}, {9,15}, {9,16}, {9,17}, {9,18}, {9,19}, {9,20},  {9,21}, {9,22}, {9,23}, {9,24}, {9,25}, {9,26}, {9,31}, {9,32}, {9,35}, {10,3}, {10,4}, {10,10}, {10,11},  {10,26},  {10,31},  {10,36},  {11,4}, {11,5}, {11,10},
{11,26},  {11,35},  {11,47},  {11,48},  {11,49},  {12,9}, {12,27},  {12,44},  {12,46},  {12,47},  {13,8}, {13,9}, {13,27},  {13,28},  {13,40}, {13,41},  {13,42},  {13,43},  {13,47},  {14,8}, {14,29},  {14,30}, {14,47},  {14,48},  {15,8}, {15,12},  {15,13},  {15,14},  {15,20}, {15,21},  {15,22},  {15,23},  {15,24},  {15,31},  {15,32},  {15,33},  {15,49},  {16,8}, {16,12},  {16,14},  {16,15},  {16,20}, {16,24},  {16,33},  {16,34},  {16,35},  {16,36},  {16,49},  {17,7}, {17,8},
{17,12},  {17,15},  {17,20}, {17,25},  {17,28},  {17,36},  {17,37},  {18,8}, {18,12},  {18,15},  {18,20}, {18,25},  {18,26},  {18,27},  {18,28},  {18,38},  {18,39},  {18,40}, {18,41},  {19,8}, {19,12},  {19,15},  {19,20}, {19,25},  {19,31},  {19,41},  {19,42},  {19,43},  {20,8}, {20,9}, {20,15},  {20,20}, {20,25},  {20,31},  {20,43},  {20,44},  {21,9}, {21,10}, {21,11},  {21,12},  {21,14},  {21,15},  {21,19},  {21,25},  {21,31},  {21,33},  {21,34},  {21,35},  {21,36},  {21,37},
{21,38},  {21,39},  {21,44},  {22,13},  {22,14},  {22,15},  {22,19},  {22,20}, {22,25},  {22,31},  {22,39},  {22,40}, {22,41},  {22,42},  {22,45},  {23,15},  {23,19},  {23,21},  {23,25},  {23,26},  {23,27},  {23,33},  {23,34},  {23,35},  {23,36},  {23,44},  {23,45},  {24,15},  {24,16},  {24,19},  {24,22},  {24,23},  {24,28},  {24,29},  {24,36},  {24,37},  {24,38},  {24,39},  {24,40}, {24,44},  {25,16},  {25,19},  {25,29},  {25,30}, {25,40}, {25,41},  {25,42},  {25,44},  {26,16},  {26,20},
{26,31},  {26,32},  {26,33},  {26,43},  {27,16},  {27,19},  {27,20}, {27,33},  {27,34},  {27,35},  {27,36},  {27,37},  {27,38},  {27,43},  {28,16},  {28,19},  {28,24},  {28,27},  {28,39},  {28,40}, {28,43},  {29,16},  {29,19},  {29,24},  {29,28},  {29,41},  {29,42},  {29,43},  {30,16},  {30,19},  {30,25},  {30,28},  {30,29},  {31,16},  {31,19},  {31,29},  {32,11},  {32,16},  {32,17},  {32,18},  {32,24},  {32,29},  {32,35},  {33,9}, {33,10}, {33,11},  {33,24},  {33,30}, {33,35},  {34,8},
{34,9}, {34,13},  {34,24},  {34,25},  {34,29},  {34,35},  {34,40}, {34,41},  {34,42},  {34,43},  {35,7}, {35,12},  {35,13},  {35,20}, {35,26},  {35,27},  {35,29},  {35,35},  {35,44},  {35,45},  {36,6}, {36,12},  {36,20}, {36,26},  {36,29},  {36,35},  {36,38},  {36,45},  {37,5}, {37,12},  {37,19},  {37,20}, {37,26},  {37,29},  {37,35},  {37,38},  {37,39},  {37,40}, {37,41},  {37,42},  {37,43},  {37,44},  {38,4}, {38,5}, {38,11},  {38,2}, {38,26},  {38,29},  {38,35},  {38,37}};

  servo_cyl.attach(11);
  servo_pen.attach(10);

  stepper_belt.setSpeed(40);
  
  servo_pen.write(pos_pen_off);
  servo_cyl.write(pos_cyl_ini);

  int prev_pos_x = 1;
  int prev_pos_y = 1;
  for (int i = 0; i<391; i++)
  {
      if(id_pix[i][0] != prev_pos_x) // if we change column
      {
          pos_cyl_actual = pos_cyl_actual + (id_pix[i][0]-prev_pos_x)*(180/39); // rotating cylinder accordingly
          servo_cyl.write(pos_cyl_actual);
          prev_pos_x = id_pix[i][0];
          delay(1000);  
      }
      int diff_y = id_pix[i][1]- prev_pos_y;
      // Moving along the Y axis
      stepper_belt.step(int(stepsPerRevolution*diff_y*0.016)); // value 5 to change
      prev_pos_y = id_pix[i][1];
      delay(500);
      servo_pen.write(pos_pen_on); // Applying pen
      delay(500);
      if (i < 390 && (id_pix[i][1]+1) != id_pix[i+1][1]) // If next pixel to draw not directly after
      {
          servo_pen.write(pos_pen_off); // removing pen
          delay(500);
      }
      delay(500);
  }
  servo_pen.write(pos_pen_off);
  
}

void loop() {
  // put your main code here, to run repeatedly:

}
